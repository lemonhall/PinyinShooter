<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>汉字音调大作战</title>
  <script src="https://cdn.jsdelivr.net/npm/pixi.js@8.2.1/dist/pixi.min.js"></script>
  <style>
    body { margin: 0; background: #f0f0f0; }
    #game-container { position: relative; }
    .tone-btn { font-size: 24px; margin: 5px; padding: 10px 15px; }
  </style>
</head>
<body>
  <!-- 添加游戏容器 -->
  <div id="game-container">
    <div id="controls" style="text-align: center; margin-top: 20px;">
      <button class="tone-btn" data-tone="1">一声 ¯</button>
      <button class="tone-btn" data-tone="2">二声 ˊ</button>
      <button class="tone-btn" data-tone="3">三声 ˇ</button>
      <button class="tone-btn" data-tone="4">四声 ˋ</button>
    </div>
  </div>

  <script>
    // 等待DOM加载完成
    document.addEventListener('DOMContentLoaded', async () => {
      // 初始化游戏
      const app = new PIXI.Application();
      await app.init({
        width: 800,
        height: 500,
        backgroundColor: 0xE8F4FF
      });
      
      // 确保正确插入canvas
      const container = document.getElementById('game-container');
      container.insertBefore(app.view, container.firstChild);

      // 游戏数据
      const characters = [
        { char: '猫', pinyin: 'māo', tone: 1 },
        { char: '狗', pinyin: 'gǒu', tone: 3 },
        { char: '书', pinyin: 'shū', tone: 1 },
        { char: '笔', pinyin: 'bǐ', tone: 3 },
        { char: '水', pinyin: 'shuǐ', tone: 3 },
        { char: '火', pinyin: 'huǒ', tone: 3 },
        { char: '山', pinyin: 'shān', tone: 1 },
        { char: '人', pinyin: 'rén', tone: 2 }
      ];

      let currentTarget = null;
      let targetHealth = 0;
      let currentTargetSprite = null; // 新增：存储当前目标的 PIXI 对象
      let currentTargetTickerCallback = null; // 新增：存储当前目标的 Ticker 回调
      const attackPower = 15;

      // 创建操作区
      const controlArea = new PIXI.Graphics()
        .beginFill(0xFFFFFF, 0.7)
        .drawRect(0, app.screen.height - 100, app.screen.width, 100)
        .endFill();
      app.stage.addChild(controlArea);

      // 创建汉字按钮
      function createCharacterButtons() {
        // 随机选择4个汉字
        const shuffled = [...characters].sort(() => Math.random() - 0.5).slice(0, 4);
        
        shuffled.forEach((charObj, i) => {
          const btn = new PIXI.Text(charObj.char, {
            fontFamily: 'Arial',
            fontSize: 36,
            fill: 0x333333
          });
          btn.interactive = true;
          btn.cursor = 'pointer';
          btn.x = 100 + i * 150;
          btn.y = app.screen.height - 70;
          btn.charData = charObj;
          
          app.stage.addChild(btn);
        });
      }

      // 创建飞来的目标
      function createFlyingTarget() {
        // 随机选择一个汉字
        const targetCharIndex = Math.floor(Math.random() * characters.length);
        const targetChar = characters[targetCharIndex];

        // 确保获取到有效的字符数据
        if (!targetChar) {
          console.error("无法获取目标汉字数据!", { index: targetCharIndex, characters });
          // 可以在这里添加一些错误处理逻辑，比如延迟后重试
          setTimeout(createFlyingTarget, 1000); // 1秒后重试
          return;
        }

        console.log("创建新目标:", targetChar.char);
        currentTarget = targetChar;
        targetHealth = 30; // 重置生命值
        
        const target = new PIXI.Text(currentTarget.char, { // target 是 PIXI.Text 对象
          fontFamily: 'Arial',
          fontSize: 48,
          fill: 0xFF0000
        });
        target.x = app.screen.width;
        target.y = 100 + Math.random() * 200;
        target.charData = currentTarget;

        currentTargetSprite = target; // 存储当前目标的 Sprite
        
        app.stage.addChild(target);
        console.log(`目标 '${currentTarget.char}' 已添加到舞台...`);

        const move = (ticker) => {
          const delta = ticker.deltaTime;
          target.x -= 2 * delta;

          if (target.x < -target.width) {
            console.log(`目标 '${currentTarget.char}' 已移出屏幕`);
            app.ticker.remove(move); // 停止当前移动回调
            if (app.stage.children.includes(target)) { // 检查是否还在舞台上
                 app.stage.removeChild(target); // 从舞台移除
            }

            // 清理全局状态
            currentTarget = null;
            currentTargetSprite = null;
            currentTargetTickerCallback = null;

            setTimeout(createFlyingTarget, 800); // 创建下一个
          }
        };
        currentTargetTickerCallback = move; // 存储当前目标的 Ticker 回调
        app.ticker.add(move);
      }

      // 检查答案 - 现在检查声调
      function checkAnswer(selectedTone) {
        if (!currentTarget) {
          console.log("当前没有目标，无法检查答案");
          return; // 如果没有目标，则不执行任何操作
        }

        console.log(`检查答案: 目标 '${currentTarget.char}'(tone ${currentTarget.tone}), 选择 tone ${selectedTone}`); // 日志

        if (selectedTone === currentTarget.tone) {
          targetHealth -= attackPower;
          console.log(`声调正确! 目标 '${currentTarget.char}' 生命值剩余: ${targetHealth}`);

          // 检查是否击毁
          if (targetHealth <= 0) {
            console.log(`目标 '${currentTarget.char}' 已击毁!`);

            // 停止移动并移除旧目标
            if (currentTargetTickerCallback) {
              app.ticker.remove(currentTargetTickerCallback);
            }
            if (currentTargetSprite && app.stage.children.includes(currentTargetSprite)) {
              app.stage.removeChild(currentTargetSprite);
            }

            // 显示击毁效果
            const boom = new PIXI.Text('💥 击毁!', {
              fontFamily: 'Arial',
              fontSize: 36,
              fill: 0xFF4500
            });
            // 定位到被击毁目标的位置
            if (currentTargetSprite) {
                 boom.x = currentTargetSprite.x;
                 boom.y = currentTargetSprite.y;
            } else { // 如果 sprite 意外丢失，放在屏幕中间
                 boom.x = app.screen.width / 2 - boom.width / 2;
                 boom.y = app.screen.height / 2 - boom.height / 2;
            }
            app.stage.addChild(boom);
            
            // 清理全局状态
            currentTarget = null;
            currentTargetSprite = null;
            currentTargetTickerCallback = null;

            // 准备下一个目标，并移除击毁效果
            setTimeout(() => {
              if (app.stage.children.includes(boom)) {
                 app.stage.removeChild(boom);
              }
              createFlyingTarget();
            }, 800); // 延迟后创建新目标

          } else {
            // 未击毁，仅显示命中效果
            const hitText = new PIXI.Text('✓ 正确!', {
              fontFamily: 'Arial',
              fontSize: 24,
              fill: 0x00FF00
            });
            hitText.x = app.screen.width / 2 - 50;
            hitText.y = 50;
            app.stage.addChild(hitText);
            
            setTimeout(() => {
              if (app.stage.children.includes(hitText)) {
                  app.stage.removeChild(hitText);
              }
            }, 500);
          }
        } else {
          // 错误反馈
          console.log(`声调错误! 目标 '${currentTarget.char}' 需要 tone ${currentTarget.tone}, 选择了 tone ${selectedTone}`); // 日志
          const missText = new PIXI.Text('✗ 声调错误!', { // 更新提示信息
            fontFamily: 'Arial',
            fontSize: 24,
            fill: 0xFF0000
          });
          missText.x = app.screen.width / 2 - 50;
          missText.y = 50;
          app.stage.addChild(missText);
          
          setTimeout(() => {
            app.stage.removeChild(missText);
          }, 500);
        }
      }

      // 初始化游戏
      createCharacterButtons();
      createFlyingTarget();

      // 绑定音调按钮 - 调用新的 checkAnswer
      document.querySelectorAll('.tone-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tone = parseInt(btn.dataset.tone);
          // alert(`你选择了 ${btn.textContent}，后续可以扩展音调验证功能`); // 移除 alert
          if (currentTarget) { // 确保有目标时才检查
             checkAnswer(tone); // 调用新的 checkAnswer，传入声调
          } else {
             console.log("点击声调按钮，但当前无目标");
          }
        });
      });
    });
  </script>
</body>
</html>
