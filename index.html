<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ±‰å­—éŸ³è°ƒå¤§ä½œæˆ˜</title>
  <script src="https://cdn.jsdelivr.net/npm/pixi.js@8.2.1/dist/pixi.min.js"></script>
  <style>
    body { margin: 0; background: #f0f0f0; }
    #game-container { position: relative; }
    .tone-btn { font-size: 24px; margin: 5px; padding: 10px 15px; }
  </style>
</head>
<body>
  <!-- æ·»åŠ æ¸¸æˆå®¹å™¨ -->
  <div id="game-container">
    <div id="controls" style="text-align: center; margin-top: 20px;">
      <button class="tone-btn" data-tone="1">ä¸€å£° Â¯</button>
      <button class="tone-btn" data-tone="2">äºŒå£° ËŠ</button>
      <button class="tone-btn" data-tone="3">ä¸‰å£° Ë‡</button>
      <button class="tone-btn" data-tone="4">å››å£° Ë‹</button>
    </div>
  </div>

  <script>
    // ç­‰å¾…DOMåŠ è½½å®Œæˆ
    document.addEventListener('DOMContentLoaded', async () => {
      // åˆå§‹åŒ–æ¸¸æˆ
      const app = new PIXI.Application();
      await app.init({
        width: 800,
        height: 500,
        backgroundColor: 0xE8F4FF
      });
      
      // ç¡®ä¿æ­£ç¡®æ’å…¥canvas
      const container = document.getElementById('game-container');
      container.insertBefore(app.view, container.firstChild);

      // æ¸¸æˆæ•°æ®
      const characters = [
        { char: 'çŒ«', pinyin: 'mÄo', tone: 1, emoji: 'ğŸ±' },
        { char: 'ç‹—', pinyin: 'gÇ’u', tone: 3, emoji: 'ğŸ¶' },
        { char: 'ä¹¦', pinyin: 'shÅ«', tone: 1, emoji: 'ğŸ“–' },
        { char: 'ç¬”', pinyin: 'bÇ', tone: 3, emoji: 'âœï¸' },
        { char: 'æ°´', pinyin: 'shuÇ', tone: 3, emoji: 'ğŸ’§' },
        { char: 'ç«', pinyin: 'huÇ’', tone: 3, emoji: 'ğŸ”¥' },
        { char: 'å±±', pinyin: 'shÄn', tone: 1, emoji: 'â›°ï¸' },
        { char: 'äºº', pinyin: 'rÃ©n', tone: 2, emoji: 'ğŸ§‘' },
        { char: 'å¤©', pinyin: 'tiÄn', tone: 1, emoji: 'â˜€ï¸' },
        { char: 'åœ°', pinyin: 'dÃ¬', tone: 4, emoji: 'ğŸŒ' },
        { char: 'æœˆ', pinyin: 'yuÃ¨', tone: 4, emoji: 'ğŸŒ™' },
        { char: 'æ—¥', pinyin: 'rÃ¬', tone: 4, emoji: 'â˜€ï¸' },
        { char: 'æ˜Ÿ', pinyin: 'xÄ«ng', tone: 1, emoji: 'â­' },
        { char: 'äº‘', pinyin: 'yÃºn', tone: 2, emoji: 'â˜ï¸' },
        { char: 'é£', pinyin: 'fÄ“ng', tone: 1, emoji: 'ğŸŒ¬ï¸' },
        { char: 'é›¨', pinyin: 'yÇ”', tone: 3, emoji: 'ğŸŒ§ï¸' },
        { char: 'ç”µ', pinyin: 'diÃ n', tone: 4, emoji: 'âš¡' },
        { char: 'èŠ±', pinyin: 'huÄ', tone: 1, emoji: 'ğŸŒ¸' },
        { char: 'è‰', pinyin: 'cÇo', tone: 3, emoji: 'ğŸŒ¿' },
        { char: 'æ ‘', pinyin: 'shÃ¹', tone: 4, emoji: 'ğŸŒ³' },
        { char: 'é¸Ÿ', pinyin: 'niÇo', tone: 3, emoji: 'ğŸ¦' },
        { char: 'é±¼', pinyin: 'yÃº', tone: 2, emoji: 'ğŸŸ' },
        { char: 'é©¬', pinyin: 'mÇ', tone: 3, emoji: 'ğŸ' },
        { char: 'ç‰›', pinyin: 'niÃº', tone: 2, emoji: 'ğŸ‚' },
        { char: 'ç¾Š', pinyin: 'yÃ¡ng', tone: 2, emoji: 'ğŸ‘' },
        { char: 'å·¦', pinyin: 'zuÇ’', tone: 3, emoji: 'ğŸ‘ˆ' },
        { char: 'å³', pinyin: 'yÃ²u', tone: 4, emoji: 'ğŸ‘‰' },
        { char: 'å¤§', pinyin: 'dÃ ', tone: 4, emoji: 'ğŸ˜' },
        { char: 'å°', pinyin: 'xiÇo', tone: 3, emoji: 'ğŸ­' },
        { char: 'è½¦', pinyin: 'chÄ“', tone: 1, emoji: 'ğŸš—' },
        { char: 'èˆ¹', pinyin: 'chuÃ¡n', tone: 2, emoji: 'ğŸš¢' },
        { char: 'é—¨', pinyin: 'mÃ©n', tone: 2, emoji: 'ğŸšª' },
        { char: 'åˆ€', pinyin: 'dÄo', tone: 1, emoji: 'ğŸ”ª' },
        { char: 'è¡£', pinyin: 'yÄ«', tone: 1, emoji: 'ğŸ‘•' },
        { char: 'é£Ÿ', pinyin: 'shÃ­', tone: 2, emoji: 'ğŸ”' },
        { char: 'ä½', pinyin: 'zhÃ¹', tone: 4, emoji: 'ğŸ ' },
        { char: 'è¡Œ', pinyin: 'xÃ­ng', tone: 2, emoji: 'ğŸš¶' },
        { char: 'æ‰‹', pinyin: 'shÇ’u', tone: 3, emoji: 'âœ‹' },
        { char: 'è¶³', pinyin: 'zÃº', tone: 2, emoji: 'ğŸ¦¶' },
        { char: 'å¤´', pinyin: 'tÃ³u', tone: 2, emoji: 'ğŸ‘¤' },
        { char: 'å¿ƒ', pinyin: 'xÄ«n', tone: 1, emoji: 'â¤ï¸' },
        { char: 'çœ¼', pinyin: 'yÇn', tone: 3, emoji: 'ğŸ‘€' },
        { char: 'è€³', pinyin: 'Ä›r', tone: 3, emoji: 'ğŸ‘‚' },
        { char: 'å£', pinyin: 'kÇ’u', tone: 3, emoji: 'ğŸ‘„' },
        { char: 'é¼»', pinyin: 'bÃ­', tone: 2, emoji: 'ğŸ‘ƒ' },
        { char: 'ç¬‘', pinyin: 'xiÃ o', tone: 4, emoji: 'ğŸ˜„' },
        { char: 'å“­', pinyin: 'kÅ«', tone: 1, emoji: 'ğŸ˜­' },
        { char: 'çˆ±', pinyin: 'Ã i', tone: 4, emoji: 'â¤ï¸' },
        { char: 'é’±', pinyin: 'qiÃ¡n', tone: 2, emoji: 'ğŸ’°' },
        { char: 'çƒ', pinyin: 'qiÃº', tone: 2, emoji: 'âš½' },
        { char: 'ç¯', pinyin: 'dÄ“ng', tone: 1, emoji: 'ğŸ’¡' },
        { char: 'ç”»', pinyin: 'huÃ ', tone: 4, emoji: 'ğŸ–¼ï¸' },
        { char: 'å”±', pinyin: 'chÃ ng', tone: 4, emoji: 'ğŸ¤' },
        { char: 'è·³', pinyin: 'tiÃ o', tone: 4, emoji: 'ğŸ’ƒ' },
        { char: 'è·‘', pinyin: 'pÇo', tone: 3, emoji: 'ğŸƒ' },
        { char: 'é£', pinyin: 'fÄ“i', tone: 1, emoji: 'âœˆï¸' },
        { char: 'å', pinyin: 'zuÃ²', tone: 4, emoji: 'ğŸª‘' },
        { char: 'ç«™', pinyin: 'zhÃ n', tone: 4, emoji: 'ğŸ§' }
      ];

      let currentTarget = null;
      let targetHealth = 0;
      let currentTargetSprite = null; // æ–°å¢ï¼šå­˜å‚¨å½“å‰ç›®æ ‡çš„ PIXI å¯¹è±¡
      let currentTargetTickerCallback = null; // æ–°å¢ï¼šå­˜å‚¨å½“å‰ç›®æ ‡çš„ Ticker å›è°ƒ
      const attackPower = 15;

      // æ–°å¢ï¼šç©å®¶æ•°æ®
      let playerHealth = 100; // åˆå§‹ç”Ÿå‘½å€¼
      const playerPosition = { x: 400, y: 450 }; // ç©å®¶åŸºå‡†ä½ç½® (åº•éƒ¨ä¸­é—´)
      let playerSprite = null; // ç©å®¶çš„ PIXI å¯¹è±¡
      let healthText = null; // æ˜¾ç¤ºç”Ÿå‘½å€¼çš„ PIXI.Text å¯¹è±¡
      // let playerScore = 0; // å¦‚æœéœ€è¦åˆ†æ•°ï¼Œå–æ¶ˆæ³¨é‡Š
      // let scoreText = null;

      // åˆ›å»ºæ“ä½œåŒº
      const controlArea = new PIXI.Graphics()
        .beginFill(0xFFFFFF, 0.7)
        .drawRect(0, app.screen.height - 100, app.screen.width, 100)
        .endFill();
      app.stage.addChild(controlArea);

      // åˆ›å»ºç©å®¶å›¾å½¢ (ä½¿ç”¨ SVG ç›¾ç‰Œ)
      const playerSvgString = '<svg width="60" height="70" viewBox="0 0 60 70" xmlns="http://www.w3.org/2000/svg"><path d="M 5 15 A 25 25 0 0 1 55 15 L 55 50 L 30 65 L 5 50 Z" fill="dodgerblue" stroke="black" stroke-width="2"/></svg>';
      playerSprite = new PIXI.Graphics().svg(playerSvgString);

      /* // ç§»é™¤æ—§çš„çŸ©å½¢ç»˜åˆ¶ä»£ç 
      playerSprite = new PIXI.Graphics()
        .beginFill(0x0000FF) // è“è‰²
        .drawRect(0, 0, 80, 20) // å®½åº¦80, é«˜åº¦20
        .endFill();
      */

      // å®šä½ç©å®¶ (åŸºäºæ–°çš„ SVG å›¾å½¢å°ºå¯¸è‡ªåŠ¨è®¡ç®—å±…ä¸­)
      playerSprite.x = playerPosition.x - playerSprite.width / 2; 
      playerSprite.y = playerPosition.y - playerSprite.height / 2;
      app.stage.addChild(playerSprite);
      console.log("ç©å®¶ (SVGç›¾ç‰Œ) å·²åˆ›å»ºå¹¶æ·»åŠ åˆ°èˆå°");

      // åˆ›å»ºç”Ÿå‘½å€¼æ–‡æœ¬
      healthText = new PIXI.Text(`ç”Ÿå‘½å€¼: ${playerHealth}`, {
        fontFamily: 'Arial',
        fontSize: 20,
        fill: 0x000000 // é»‘è‰²
      });
      healthText.x = 10; // æ”¾åœ¨å·¦ä¸Šè§’
      healthText.y = 10;
      app.stage.addChild(healthText);
      console.log("ç”Ÿå‘½å€¼æ–‡æœ¬å·²åˆ›å»º");

      // åˆ›å»ºæ±‰å­—æŒ‰é’® (ç°åœ¨æ³¨é‡Šæ‰ï¼Œå› ä¸ºä¸å†éœ€è¦)
      // createCharacterButtons();

      // åˆ›å»ºé£æ¥çš„ç›®æ ‡ (ç»„åˆå½¢å¼ï¼šæ•Œäºº + å¤´é¡¶æ–‡å­—)
      function createFlyingTarget() {
        const targetCharIndex = Math.floor(Math.random() * characters.length);
        const targetChar = characters[targetCharIndex];

        if (!targetChar) {
          console.error("æ— æ³•è·å–ç›®æ ‡æ±‰å­—æ•°æ®!");
          setTimeout(createFlyingTarget, 1000);
          return;
        }

        console.log("åˆ›å»ºæ–°ç›®æ ‡ç»„åˆ:", targetChar.char);
        currentTarget = targetChar;
        targetHealth = 30; // é‡ç½®ç”Ÿå‘½å€¼
        
        // åˆ›å»º Container
        const targetContainer = new PIXI.Container();
        targetContainer.charData = currentTarget; // å°†æ•°æ®å…³è”åˆ° Container

        // 1. åˆ›å»ºæ•Œäºº Emoji æ–‡æœ¬
        const enemyEmojiText = new PIXI.Text(currentTarget.emoji, {
          fontFamily: 'Arial', // ç¡®ä¿å­—ä½“æ”¯æŒ Emoji
          fontSize: 40 // Emoji å­—å·å¯ä»¥å¤§ä¸€äº›
        });
        // å°† Emoji æ”¾åœ¨ Container çš„ (0, 0) ä½ç½®ä½œä¸ºåŸºå‡†
        enemyEmojiText.x = 0;
        enemyEmojiText.y = 0;
        enemyEmojiText.anchor.set(0.5, 0.5); // è®¾ç½®é”šç‚¹ä¸ºä¸­å¿ƒï¼Œæ–¹ä¾¿å®šä½
        targetContainer.addChild(enemyEmojiText);

        // 2. åˆ›å»ºæ±‰å­—æ–‡æœ¬ (æ˜¾ç¤ºåœ¨ Emoji ä¸Šæ–¹)
        const charText = new PIXI.Text(currentTarget.char, {
          fontFamily: 'Arial',
          fontSize: 24, // å¯ä»¥é€‚å½“è°ƒå°ä¸€ç‚¹
          fill: 0x000000, // é»‘è‰²æ–‡å­—ï¼Œæ›´æ¸…æ™°
          align: 'center'
        });
        // å®šä½æ–‡å­—åœ¨ Emoji å¤´é¡¶å±…ä¸­
        charText.anchor.set(0.5, 1); // é”šç‚¹è®¾ç½®åœ¨æ–‡å­—åº•éƒ¨ä¸­å¿ƒ
        charText.x = enemyEmojiText.x; // æ°´å¹³å±…ä¸­å¯¹é½ Emoji ä¸­å¿ƒ
        charText.y = enemyEmojiText.y - enemyEmojiText.height / 2 - 5; // Emoji ä¸­å¿ƒç‚¹ä¸Šæ–¹å†å‡å» Emoji é«˜åº¦ä¸€åŠï¼Œç•™ 5px é—´è·
        targetContainer.addChild(charText);

        // è®¾ç½® Container çš„åˆå§‹ä½ç½® (åŸºäºæ–°çš„å†…å®¹)
        const containerBounds = targetContainer.getLocalBounds(); // è·å–å±€éƒ¨è¾¹ç•Œæ¥ä¼°ç®—å°ºå¯¸
        targetContainer.x = Math.random() * (app.screen.width - containerBounds.width);
        targetContainer.y = -containerBounds.height; // ä»å±å¹•é¡¶éƒ¨å¤–å¼€å§‹

        currentTargetSprite = targetContainer; // å…¨å±€å˜é‡ç°åœ¨æŒ‡å‘ Container
        
        app.stage.addChild(targetContainer);
        console.log(`ç›®æ ‡ç»„åˆ '${currentTarget.char}' å·²æ·»åŠ åˆ°èˆå°...`);

        // ç§»åŠ¨ Container çš„é€»è¾‘
        const move = (ticker) => {
          const delta = ticker.deltaTime;
          const speed = 1.8; 

          // è®¡ç®—æœå‘ç©å®¶çš„æ–¹å‘å‘é‡ (ç›®æ ‡æ˜¯ Container çš„ä¸­å¿ƒ)
          const dx = playerPosition.x - (targetContainer.x + containerBounds.width / 2);
          const dy = playerPosition.y - (targetContainer.y + containerBounds.height / 2);
          const length = Math.sqrt(dx * dx + dy * dy);

          if (length > 1) { 
            const normalizedDx = dx / length;
            const normalizedDy = dy / length;
            targetContainer.x += normalizedDx * speed * delta;
            targetContainer.y += normalizedDy * speed * delta;
          }

          // ç¢°æ’æ£€æµ‹é€»è¾‘ (ä½¿ç”¨ Container çš„è¾¹ç•Œ)
          const enemyBoundsRect = targetContainer.getBounds().rectangle; 
          const playerBoundsRect = playerSprite.getBounds().rectangle; 

          if (enemyBoundsRect && playerBoundsRect && enemyBoundsRect.intersects(playerBoundsRect)) { 
             console.log(`ç›®æ ‡ç»„åˆ '${currentTarget.char}' å‡»ä¸­ç©å®¶!`);
             // å‡å°‘ç©å®¶ç”Ÿå‘½å€¼
             playerHealth -= 10; // æ¯æ¬¡å‡»ä¸­å‡å°‘ 10 ç‚¹ç”Ÿå‘½å€¼
             healthText.text = `ç”Ÿå‘½å€¼: ${playerHealth}`; // æ›´æ–°æ˜¾ç¤º
             console.log(`ç©å®¶ç”Ÿå‘½å€¼å‰©ä½™: ${playerHealth}`);

             // ç§»é™¤æ•Œäºº Container
             app.ticker.remove(move);
             if (app.stage.children.includes(targetContainer)) { // æ£€æŸ¥å¹¶ç§»é™¤ Container
               app.stage.removeChild(targetContainer);
             }

             // åˆ¤æ–­æ¸¸æˆæ˜¯å¦ç»“æŸ
             if (playerHealth <= 0) {
               console.log("æ¸¸æˆç»“æŸ!");
               healthText.text = "æ¸¸æˆç»“æŸ!"; // æ›´æ–°æ–‡æœ¬æç¤º
               // (å¾…å®ç°) æ˜¾ç¤ºæ¸¸æˆç»“æŸç”»é¢æˆ–æç¤º
               app.ticker.stop(); // åœæ­¢æ‰€æœ‰ ticker æ›´æ–°ï¼Œæš‚åœæ¸¸æˆ
             } else {
               setTimeout(createFlyingTarget, 500);
             }
           }
           // ç§»å‡ºå±å¹•åº•éƒ¨çš„é€»è¾‘ (ä¹Ÿè¦åŸºäº Container)
           else if (targetContainer.y > app.screen.height + 20) {
              console.log(`ç›®æ ‡ç»„åˆ '${currentTarget.char}' å·²ç§»å‡ºå±å¹•åº•éƒ¨ (æœªå‡»ä¸­)`);
              app.ticker.remove(move);
              if (app.stage.children.includes(targetContainer)) {
                  app.stage.removeChild(targetContainer);
              }
              currentTarget = null;
              currentTargetSprite = null;
              currentTargetTickerCallback = null;
              setTimeout(createFlyingTarget, 800); 
          }
        };
        currentTargetTickerCallback = move; // å­˜å‚¨ Container çš„ Ticker å›è°ƒ
        app.ticker.add(move);
      }

      // æ£€æŸ¥ç­”æ¡ˆ - å‡»æ¯æ•ˆæœå®šä½å’Œç§»é™¤éœ€è¦å¯¹åº” Container
      function checkAnswer(selectedTone) {
        if (!currentTarget) {
          console.log("å½“å‰æ²¡æœ‰ç›®æ ‡ï¼Œæ— æ³•æ£€æŸ¥ç­”æ¡ˆ");
          return; // å¦‚æœæ²¡æœ‰ç›®æ ‡ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
        }

        console.log(`æ£€æŸ¥ç­”æ¡ˆ: ç›®æ ‡ '${currentTarget.char}'(tone ${currentTarget.tone}), é€‰æ‹© tone ${selectedTone}`); // æ—¥å¿—

        if (selectedTone === currentTarget.tone) {
          targetHealth -= attackPower;
          console.log(`å£°è°ƒæ­£ç¡®! ç›®æ ‡ '${currentTarget.char}' ç”Ÿå‘½å€¼å‰©ä½™: ${targetHealth}`);

          // æ£€æŸ¥æ˜¯å¦å‡»æ¯
          if (targetHealth <= 0) {
            console.log(`ç›®æ ‡ç»„åˆ '${currentTarget.char}' å·²å‡»æ¯!`); // æ›´æ–°æ—¥å¿—

            // åœæ­¢ç§»åŠ¨å¹¶ç§»é™¤æ—§ç›®æ ‡ Container
            if (currentTargetTickerCallback) {
              app.ticker.remove(currentTargetTickerCallback);
            }
            // ä½¿ç”¨ currentTargetSprite (ç°åœ¨æ˜¯ Container)
            if (currentTargetSprite && app.stage.children.includes(currentTargetSprite)) {
              app.stage.removeChild(currentTargetSprite); 
            }

            // æ˜¾ç¤ºå‡»æ¯æ•ˆæœ (å®šä½åˆ° Container çš„ä½ç½®)
            const boom = new PIXI.Text('ğŸ’¥ å‡»æ¯!', {
              fontFamily: 'Arial',
              fontSize: 36,
              fill: 0xFF4500
            });
            if (currentTargetSprite) {
                 boom.x = currentTargetSprite.x + currentTargetSprite.width / 2 - boom.width / 2; // å±…ä¸­
                 boom.y = currentTargetSprite.y + currentTargetSprite.height / 2 - boom.height / 2;
            } else { 
                 // ... (å¤‡ç”¨å®šä½é€»è¾‘)
            }
            app.stage.addChild(boom);
            
            // æ¸…ç†å…¨å±€çŠ¶æ€
            currentTarget = null;
            currentTargetSprite = null;
            currentTargetTickerCallback = null;

            // å‡†å¤‡ä¸‹ä¸€ä¸ªç›®æ ‡ Container
            setTimeout(() => {
              if (app.stage.children.includes(boom)) {
                 app.stage.removeChild(boom);
              }
              createFlyingTarget();
            }, 800); // å»¶è¿Ÿååˆ›å»ºæ–°ç›®æ ‡ Container

          } else {
            // æœªå‡»æ¯ï¼Œä»…æ˜¾ç¤ºå‘½ä¸­æ•ˆæœ
            const hitText = new PIXI.Text('âœ“ æ­£ç¡®!', {
              fontFamily: 'Arial',
              fontSize: 24,
              fill: 0x00FF00
            });
            hitText.x = app.screen.width / 2 - 50;
            hitText.y = 50;
            app.stage.addChild(hitText);
            
            setTimeout(() => {
              if (app.stage.children.includes(hitText)) {
                  app.stage.removeChild(hitText);
              }
            }, 500);
          }
        } else {
          // é”™è¯¯åé¦ˆ
          console.log(`å£°è°ƒé”™è¯¯! ç›®æ ‡ '${currentTarget.char}' éœ€è¦ tone ${currentTarget.tone}, é€‰æ‹©äº† tone ${selectedTone}`); // æ—¥å¿—
          const missText = new PIXI.Text('âœ— å£°è°ƒé”™è¯¯!', { // æ›´æ–°æç¤ºä¿¡æ¯
            fontFamily: 'Arial',
            fontSize: 24,
            fill: 0xFF0000
          });
          missText.x = app.screen.width / 2 - 50;
          missText.y = 50;
          app.stage.addChild(missText);
          
          setTimeout(() => {
            app.stage.removeChild(missText);
          }, 500);
        }
      }

      // åˆå§‹åŒ–æ¸¸æˆ
      // createCharacterButtons();
      createFlyingTarget();

      // ç»‘å®šéŸ³è°ƒæŒ‰é’® - è°ƒç”¨æ–°çš„ checkAnswer
      document.querySelectorAll('.tone-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tone = parseInt(btn.dataset.tone);
          // alert(`ä½ é€‰æ‹©äº† ${btn.textContent}ï¼Œåç»­å¯ä»¥æ‰©å±•éŸ³è°ƒéªŒè¯åŠŸèƒ½`); // ç§»é™¤ alert
          if (currentTarget) { // ç¡®ä¿æœ‰ç›®æ ‡æ—¶æ‰æ£€æŸ¥
             checkAnswer(tone); // è°ƒç”¨æ–°çš„ checkAnswerï¼Œä¼ å…¥å£°è°ƒ
          } else {
             console.log("ç‚¹å‡»å£°è°ƒæŒ‰é’®ï¼Œä½†å½“å‰æ— ç›®æ ‡");
          }
        });
      });
    });
  </script>
</body>
</html>
