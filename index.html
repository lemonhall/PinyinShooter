<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ±‰å­—éŸ³è°ƒå¤§ä½œæˆ˜</title>
  <script src="https://cdn.jsdelivr.net/npm/pixi.js@8.2.1/dist/pixi.min.js"></script>
  <style>
    body { margin: 0; background: #f0f0f0; }
    #game-container { position: relative; }
    .tone-btn { font-size: 24px; margin: 5px; padding: 10px 15px; }
  </style>
</head>
<body>
  <!-- æ·»åŠ æ¸¸æˆå®¹å™¨ -->
  <div id="game-container">
    <div id="controls" style="text-align: center; margin-top: 20px;">
      <button class="tone-btn" data-tone="1">ä¸€å£° Â¯</button>
      <button class="tone-btn" data-tone="2">äºŒå£° ËŠ</button>
      <button class="tone-btn" data-tone="3">ä¸‰å£° Ë‡</button>
      <button class="tone-btn" data-tone="4">å››å£° Ë‹</button>
    </div>
  </div>

  <script>
    // ç­‰å¾…DOMåŠ è½½å®Œæˆ
    document.addEventListener('DOMContentLoaded', async () => {
      // åˆå§‹åŒ–æ¸¸æˆ
      const app = new PIXI.Application();
      await app.init({
        width: 800,
        height: 500,
        backgroundColor: 0xE8F4FF
      });
      
      // ç¡®ä¿æ­£ç¡®æ’å…¥canvas
      const container = document.getElementById('game-container');
      container.insertBefore(app.view, container.firstChild);

      // æ¸¸æˆæ•°æ®
      const characters = [
        { char: 'çŒ«', pinyin: 'mÄo', tone: 1 },
        { char: 'ç‹—', pinyin: 'gÇ’u', tone: 3 },
        { char: 'ä¹¦', pinyin: 'shÅ«', tone: 1 },
        { char: 'ç¬”', pinyin: 'bÇ', tone: 3 },
        { char: 'æ°´', pinyin: 'shuÇ', tone: 3 },
        { char: 'ç«', pinyin: 'huÇ’', tone: 3 },
        { char: 'å±±', pinyin: 'shÄn', tone: 1 },
        { char: 'äºº', pinyin: 'rÃ©n', tone: 2 }
      ];

      let currentTarget = null;
      let targetHealth = 0;
      const attackPower = 15;

      // åˆ›å»ºæ“ä½œåŒº
      const controlArea = new PIXI.Graphics()
        .beginFill(0xFFFFFF, 0.7)
        .drawRect(0, app.screen.height - 100, app.screen.width, 100)
        .endFill();
      app.stage.addChild(controlArea);

      // åˆ›å»ºæ±‰å­—æŒ‰é’®
      function createCharacterButtons() {
        // éšæœºé€‰æ‹©4ä¸ªæ±‰å­—
        const shuffled = [...characters].sort(() => Math.random() - 0.5).slice(0, 4);
        
        shuffled.forEach((charObj, i) => {
          const btn = new PIXI.Text(charObj.char, {
            fontFamily: 'Arial',
            fontSize: 36,
            fill: 0x333333
          });
          btn.interactive = true;
          btn.cursor = 'pointer';
          btn.x = 100 + i * 150;
          btn.y = app.screen.height - 70;
          btn.charData = charObj;
          
          btn.on('pointerdown', () => {
            if (currentTarget) {
              checkAnswer(charObj);
            }
          });
          
          app.stage.addChild(btn);
        });
      }

      // åˆ›å»ºé£æ¥çš„ç›®æ ‡
      function createFlyingTarget() {
        // éšæœºé€‰æ‹©ä¸€ä¸ªæ±‰å­—
        const targetCharIndex = Math.floor(Math.random() * characters.length);
        const targetChar = characters[targetCharIndex];

        // ç¡®ä¿è·å–åˆ°æœ‰æ•ˆçš„å­—ç¬¦æ•°æ®
        if (!targetChar) {
          console.error("æ— æ³•è·å–ç›®æ ‡æ±‰å­—æ•°æ®!", { index: targetCharIndex, characters });
          // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€äº›é”™è¯¯å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚å»¶è¿Ÿåé‡è¯•
          setTimeout(createFlyingTarget, 1000); // 1ç§’åé‡è¯•
          return;
        }

        console.log("åˆ›å»ºæ–°ç›®æ ‡:", targetChar.char); // æ—¥å¿—ï¼šè®°å½•åˆ›å»ºçš„ç›®æ ‡
        currentTarget = targetChar;
        targetHealth = 30; // 2-3æ¬¡æ­£ç¡®æ”»å‡»å¯å‡»æ¯
        
        const target = new PIXI.Text(currentTarget.char, { // ç›´æ¥ä½¿ç”¨ currentTarget
          fontFamily: 'Arial',
          fontSize: 48,
          fill: 0xFF0000
        });
        target.x = app.screen.width; // ä»å±å¹•å³ä¾§å¼€å§‹
        target.y = 100 + Math.random() * 200; // éšæœºYè½´ä½ç½®
        target.charData = currentTarget; // å…³è”æ•°æ®
        
        app.stage.addChild(target);
        console.log(`ç›®æ ‡ '${currentTarget.char}' å·²æ·»åŠ åˆ°èˆå°ï¼Œä½ç½®: x=${target.x.toFixed(0)}, y=${target.y.toFixed(0)}`); // æ—¥å¿—ï¼šè®°å½•æ·»åŠ å’Œä½ç½®

        // ä½¿ç”¨PixiJSçš„tickerä»£æ›¿requestAnimationFrame
        const move = (ticker) => { // å›è°ƒå‚æ•°æ˜¯ Ticker å¯¹è±¡
          const delta = ticker.deltaTime; // ä» Ticker å¯¹è±¡è·å– deltaTime
          target.x -= 2 * delta; // æ ¹æ®æ—¶é—´å·®ç§»åŠ¨ï¼Œé€Ÿåº¦æ›´å¹³æ»‘
          // console.log(`ç§»åŠ¨ç›®æ ‡ '${currentTarget.char}': x=${target.x.toFixed(2)}, delta=${delta.toFixed(2)}`); // æ—¥å¿—ï¼šé¢‘ç¹è®°å½•ç§»åŠ¨ï¼ˆå¯é€‰ï¼‰

          if (target.x < -target.width) { // åˆ¤æ–­æ¡ä»¶æ›´ç²¾ç¡®ï¼Œè€ƒè™‘æ–‡å­—å®½åº¦
            console.log(`ç›®æ ‡ '${currentTarget.char}' å·²ç§»å‡ºå±å¹•`); // æ—¥å¿—ï¼šè®°å½•ç§»å‡º
            app.ticker.remove(move); // åœæ­¢å½“å‰ç§»åŠ¨
            app.stage.removeChild(target); // ä»èˆå°ç§»é™¤
            // ç¨å¾®å»¶è¿Ÿååˆ›å»ºä¸‹ä¸€ä¸ªç›®æ ‡
            setTimeout(createFlyingTarget, 800); // å»¶è¿Ÿ 800ms
          }
        };
        app.ticker.add(move); // å¯åŠ¨ç§»åŠ¨

        // è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼ç›®å‰æ²¡æœ‰è¢«ä½¿ç”¨
        // return target;
      }

      // æ£€æŸ¥ç­”æ¡ˆ
      function checkAnswer(selectedChar) {
        if (selectedChar.char === currentTarget.char) {
          targetHealth -= attackPower;
          
          // å‡»ä¸­æ•ˆæœ
          const hitText = new PIXI.Text('âœ“ æ­£ç¡®!', {
            fontFamily: 'Arial',
            fontSize: 24,
            fill: 0x00FF00
          });
          hitText.x = app.screen.width / 2 - 50;
          hitText.y = 50;
          app.stage.addChild(hitText);
          
          setTimeout(() => {
            app.stage.removeChild(hitText);
          }, 500);
          
          if (targetHealth <= 0) {
            // å‡»æ¯æ•ˆæœ
            const boom = new PIXI.Text('ğŸ’¥ å‡»æ¯!', {
              fontFamily: 'Arial',
              fontSize: 36,
              fill: 0xFF4500
            });
            boom.x = target.x;
            boom.y = target.y;
            app.stage.addChild(boom);
            
            setTimeout(() => {
              app.stage.removeChild(boom);
              createFlyingTarget();
            }, 800);
          }
        } else {
          // é”™è¯¯åé¦ˆ
          const missText = new PIXI.Text('âœ— é”™è¯¯!', {
            fontFamily: 'Arial',
            fontSize: 24,
            fill: 0xFF0000
          });
          missText.x = app.screen.width / 2 - 50;
          missText.y = 50;
          app.stage.addChild(missText);
          
          setTimeout(() => {
            app.stage.removeChild(missText);
          }, 500);
        }
      }

      // åˆå§‹åŒ–æ¸¸æˆ
      createCharacterButtons();
      createFlyingTarget();

      // ç»‘å®šéŸ³è°ƒæŒ‰é’®
      document.querySelectorAll('.tone-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tone = parseInt(btn.dataset.tone);
          alert(`ä½ é€‰æ‹©äº† ${btn.textContent}ï¼Œåç»­å¯ä»¥æ‰©å±•éŸ³è°ƒéªŒè¯åŠŸèƒ½`);
        });
      });
    });
  </script>
</body>
</html>
