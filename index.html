<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ±‰å­—éŸ³è°ƒå¤§ä½œæˆ˜</title>
  <script src="https://cdn.jsdelivr.net/npm/pixi.js@8.2.1/dist/pixi.min.js"></script>
  <style>
    body { margin: 0; background: #f0f0f0; }
    #game-container { position: relative; }
    .tone-btn { font-size: 24px; margin: 5px; padding: 10px 15px; }
  </style>
</head>
<body>
  <!-- æ·»åŠ æ¸¸æˆå®¹å™¨ -->
  <div id="game-container">
    <div id="controls" style="text-align: center; margin-top: 20px;">
      <button class="tone-btn" data-tone="1">ä¸€å£° Â¯</button>
      <button class="tone-btn" data-tone="2">äºŒå£° ËŠ</button>
      <button class="tone-btn" data-tone="3">ä¸‰å£° Ë‡</button>
      <button class="tone-btn" data-tone="4">å››å£° Ë‹</button>
    </div>
  </div>

  <script>
    // ç­‰å¾…DOMåŠ è½½å®Œæˆ
    document.addEventListener('DOMContentLoaded', async () => {
      // åˆå§‹åŒ–æ¸¸æˆ
      const app = new PIXI.Application();
      await app.init({
        width: 800,
        height: 500,
        backgroundColor: 0xE8F4FF
      });
      
      // ç¡®ä¿æ­£ç¡®æ’å…¥canvas
      const container = document.getElementById('game-container');
      container.insertBefore(app.view, container.firstChild);

      // æ¸¸æˆæ•°æ®
      const characters = [
        { char: 'çŒ«', pinyin: 'mÄo', tone: 1 },
        { char: 'ç‹—', pinyin: 'gÇ’u', tone: 3 },
        { char: 'ä¹¦', pinyin: 'shÅ«', tone: 1 },
        { char: 'ç¬”', pinyin: 'bÇ', tone: 3 },
        { char: 'æ°´', pinyin: 'shuÇ', tone: 3 },
        { char: 'ç«', pinyin: 'huÇ’', tone: 3 },
        { char: 'å±±', pinyin: 'shÄn', tone: 1 },
        { char: 'äºº', pinyin: 'rÃ©n', tone: 2 }
      ];

      let currentTarget = null;
      let targetHealth = 0;
      let currentTargetSprite = null; // æ–°å¢ï¼šå­˜å‚¨å½“å‰ç›®æ ‡çš„ PIXI å¯¹è±¡
      let currentTargetTickerCallback = null; // æ–°å¢ï¼šå­˜å‚¨å½“å‰ç›®æ ‡çš„ Ticker å›è°ƒ
      const attackPower = 15;

      // æ–°å¢ï¼šç©å®¶æ•°æ®
      let playerHealth = 100; // åˆå§‹ç”Ÿå‘½å€¼
      const playerPosition = { x: 400, y: 450 }; // ç©å®¶åŸºå‡†ä½ç½® (åº•éƒ¨ä¸­é—´)
      let playerSprite = null; // ç©å®¶çš„ PIXI å¯¹è±¡
      let healthText = null; // æ˜¾ç¤ºç”Ÿå‘½å€¼çš„ PIXI.Text å¯¹è±¡
      // let playerScore = 0; // å¦‚æœéœ€è¦åˆ†æ•°ï¼Œå–æ¶ˆæ³¨é‡Š
      // let scoreText = null;

      // åˆ›å»ºæ“ä½œåŒº
      const controlArea = new PIXI.Graphics()
        .beginFill(0xFFFFFF, 0.7)
        .drawRect(0, app.screen.height - 100, app.screen.width, 100)
        .endFill();
      app.stage.addChild(controlArea);

      // åˆ›å»ºç©å®¶å›¾å½¢ (ä¸€ä¸ªç®€å•çš„çŸ©å½¢)
      playerSprite = new PIXI.Graphics()
        .beginFill(0x0000FF) // è“è‰²
        .drawRect(0, 0, 80, 20) // å®½åº¦80, é«˜åº¦20
        .endFill();
      playerSprite.x = playerPosition.x - playerSprite.width / 2; // å±…ä¸­æ”¾ç½®
      playerSprite.y = playerPosition.y - playerSprite.height / 2;
      app.stage.addChild(playerSprite);
      console.log("ç©å®¶å·²åˆ›å»ºå¹¶æ·»åŠ åˆ°èˆå°");

      // åˆ›å»ºç”Ÿå‘½å€¼æ–‡æœ¬
      healthText = new PIXI.Text(`ç”Ÿå‘½å€¼: ${playerHealth}`, {
        fontFamily: 'Arial',
        fontSize: 20,
        fill: 0x000000 // é»‘è‰²
      });
      healthText.x = 10; // æ”¾åœ¨å·¦ä¸Šè§’
      healthText.y = 10;
      app.stage.addChild(healthText);
      console.log("ç”Ÿå‘½å€¼æ–‡æœ¬å·²åˆ›å»º");

      // åˆ›å»ºæ±‰å­—æŒ‰é’®
      function createCharacterButtons() {
        // éšæœºé€‰æ‹©4ä¸ªæ±‰å­—
        const shuffled = [...characters].sort(() => Math.random() - 0.5).slice(0, 4);
        
        shuffled.forEach((charObj, i) => {
          const btn = new PIXI.Text(charObj.char, {
            fontFamily: 'Arial',
            fontSize: 36,
            fill: 0x333333
          });
          btn.interactive = true;
          btn.cursor = 'pointer';
          btn.x = 100 + i * 150;
          btn.y = app.screen.height - 70;
          btn.charData = charObj;
          
          app.stage.addChild(btn);
        });
      }

      // åˆ›å»ºé£æ¥çš„ç›®æ ‡
      function createFlyingTarget() {
        // éšæœºé€‰æ‹©ä¸€ä¸ªæ±‰å­—
        const targetCharIndex = Math.floor(Math.random() * characters.length);
        const targetChar = characters[targetCharIndex];

        // ç¡®ä¿è·å–åˆ°æœ‰æ•ˆçš„å­—ç¬¦æ•°æ®
        if (!targetChar) {
          console.error("æ— æ³•è·å–ç›®æ ‡æ±‰å­—æ•°æ®!", { index: targetCharIndex, characters });
          // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€äº›é”™è¯¯å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚å»¶è¿Ÿåé‡è¯•
          setTimeout(createFlyingTarget, 1000); // 1ç§’åé‡è¯•
          return;
        }

        console.log("åˆ›å»ºæ–°ç›®æ ‡:", targetChar.char);
        currentTarget = targetChar;
        targetHealth = 30; // é‡ç½®ç”Ÿå‘½å€¼
        
        const target = new PIXI.Text(currentTarget.char, { // target æ˜¯ PIXI.Text å¯¹è±¡
          fontFamily: 'Arial',
          fontSize: 48,
          fill: 0xFF0000
        });
        // ä¿®æ”¹åˆå§‹ä½ç½®ï¼šä»é¡¶éƒ¨éšæœº x ä½ç½®å¼€å§‹
        target.x = Math.random() * (app.screen.width - target.width); // éšæœº Xï¼Œå‡å»å®½åº¦é˜²æ­¢éƒ¨åˆ†åœ¨å±å¹•å¤–
        target.y = -target.height; // ä»å±å¹•é¡¶éƒ¨å¤–å¼€å§‹
        target.charData = currentTarget;

        currentTargetSprite = target; // å­˜å‚¨å½“å‰ç›®æ ‡çš„ Sprite
        
        app.stage.addChild(target);
        console.log(`ç›®æ ‡ '${currentTarget.char}' å·²æ·»åŠ åˆ°èˆå°...`);

        const move = (ticker) => {
          const delta = ticker.deltaTime;
          const speed = 2.5; // è°ƒæ•´ç§»åŠ¨é€Ÿåº¦

          // è®¡ç®—æœå‘ç©å®¶çš„æ–¹å‘å‘é‡
          const dx = playerPosition.x - target.x;
          const dy = playerPosition.y - target.y;
          const length = Math.sqrt(dx * dx + dy * dy);

          // å¦‚æœè·ç¦»å¤§äºä¸€ä¸ªå¾ˆå°çš„å€¼ (é¿å…é™¤ä»¥0)ï¼Œåˆ™ç§»åŠ¨
          if (length > 1) { // ç”¨å¤§äº1åƒç´ æ¥åˆ¤æ–­ï¼Œé¿å…æµ®ç‚¹è¯¯å·®
            const normalizedDx = dx / length;
            const normalizedDy = dy / length;

            target.x += normalizedDx * speed * delta;
            target.y += normalizedDy * speed * delta;
          } else {
             // å¦‚æœå·²ç»éå¸¸æ¥è¿‘æˆ–åˆ°è¾¾ç›®æ ‡ç‚¹ï¼Œå¯ä»¥è§†ä¸ºç¢°æ’ï¼ˆæˆ–è€…è®©ç¢°æ’æ£€æµ‹å¤„ç†ï¼‰
             // è¿™é‡Œæš‚æ—¶ä¸ç§»åŠ¨ï¼Œè®©ä¸‹é¢çš„ç¢°æ’æ£€æµ‹é€»è¾‘ç”Ÿæ•ˆ
             console.log(`ç›®æ ‡ '${currentTarget.char}' å·²åˆ°è¾¾ç©å®¶ä½ç½®åŒºåŸŸ`);
          }
          
          // target.y += 3 * delta; // æ—§çš„å‚ç›´å‘ä¸‹ç§»åŠ¨

          // ç¢°æ’æ£€æµ‹é€»è¾‘ä¿æŒä¸å˜
          const enemyBoundsRect = target.getBounds().rectangle;
          const playerBoundsRect = playerSprite.getBounds().rectangle;

          if (enemyBoundsRect && playerBoundsRect && enemyBoundsRect.intersects(playerBoundsRect)) {
             console.log(`ç›®æ ‡ '${currentTarget.char}' å‡»ä¸­ç©å®¶!`);

             // å‡å°‘ç©å®¶ç”Ÿå‘½å€¼
             playerHealth -= 10; // æ¯æ¬¡å‡»ä¸­å‡å°‘ 10 ç‚¹ç”Ÿå‘½å€¼
             healthText.text = `ç”Ÿå‘½å€¼: ${playerHealth}`; // æ›´æ–°æ˜¾ç¤º
             console.log(`ç©å®¶ç”Ÿå‘½å€¼å‰©ä½™: ${playerHealth}`);

             // (å¯é€‰) å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç©å®¶è¢«å‡»ä¸­çš„è§†è§‰/éŸ³æ•ˆåé¦ˆ

             // ç§»é™¤æ•Œäºº
             app.ticker.remove(move);
             if (app.stage.children.includes(target)) {
               app.stage.removeChild(target);
             }

             // æ¸…ç†å½“å‰ç›®æ ‡çŠ¶æ€
             currentTarget = null;
             currentTargetSprite = null;
             currentTargetTickerCallback = null;

             // åˆ¤æ–­æ¸¸æˆæ˜¯å¦ç»“æŸ
             if (playerHealth <= 0) {
               console.log("æ¸¸æˆç»“æŸ!");
               healthText.text = "æ¸¸æˆç»“æŸ!"; // æ›´æ–°æ–‡æœ¬æç¤º
               // (å¾…å®ç°) æ˜¾ç¤ºæ¸¸æˆç»“æŸç”»é¢æˆ–æç¤º
               app.ticker.stop(); // åœæ­¢æ‰€æœ‰ ticker æ›´æ–°ï¼Œæš‚åœæ¸¸æˆ
             } else {
               // ç”Ÿæˆä¸‹ä¸€ä¸ªæ•Œäºº
               setTimeout(createFlyingTarget, 500); // çŸ­æš‚å»¶è¿Ÿåç”Ÿæˆä¸‹ä¸€ä¸ª
             }
           }
           // ä¿ç•™åŸæ¥çš„ç§»å‡ºå±å¹•åº•éƒ¨çš„é€»è¾‘ä½œä¸ºå¤‡ç”¨ï¼Œä»¥é˜²ä¸‡ä¸€
           else if (target.y > app.screen.height + 20) { // å¢åŠ ä¸€ç‚¹ç¼“å†²
              console.log(`ç›®æ ‡ '${currentTarget.char}' å·²ç§»å‡ºå±å¹•åº•éƒ¨ (æœªå‡»ä¸­)`);
              app.ticker.remove(move);
              if (app.stage.children.includes(target)) {
                  app.stage.removeChild(target);
              }
              currentTarget = null;
              currentTargetSprite = null;
              currentTargetTickerCallback = null;
              setTimeout(createFlyingTarget, 800); // åˆ›å»ºä¸‹ä¸€ä¸ª
          }
        };
        currentTargetTickerCallback = move; // å­˜å‚¨å½“å‰ç›®æ ‡çš„ Ticker å›è°ƒ
        app.ticker.add(move);
      }

      // æ£€æŸ¥ç­”æ¡ˆ - ç°åœ¨æ£€æŸ¥å£°è°ƒ
      function checkAnswer(selectedTone) {
        if (!currentTarget) {
          console.log("å½“å‰æ²¡æœ‰ç›®æ ‡ï¼Œæ— æ³•æ£€æŸ¥ç­”æ¡ˆ");
          return; // å¦‚æœæ²¡æœ‰ç›®æ ‡ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
        }

        console.log(`æ£€æŸ¥ç­”æ¡ˆ: ç›®æ ‡ '${currentTarget.char}'(tone ${currentTarget.tone}), é€‰æ‹© tone ${selectedTone}`); // æ—¥å¿—

        if (selectedTone === currentTarget.tone) {
          targetHealth -= attackPower;
          console.log(`å£°è°ƒæ­£ç¡®! ç›®æ ‡ '${currentTarget.char}' ç”Ÿå‘½å€¼å‰©ä½™: ${targetHealth}`);

          // æ£€æŸ¥æ˜¯å¦å‡»æ¯
          if (targetHealth <= 0) {
            console.log(`ç›®æ ‡ '${currentTarget.char}' å·²å‡»æ¯!`);

            // åœæ­¢ç§»åŠ¨å¹¶ç§»é™¤æ—§ç›®æ ‡
            if (currentTargetTickerCallback) {
              app.ticker.remove(currentTargetTickerCallback);
            }
            if (currentTargetSprite && app.stage.children.includes(currentTargetSprite)) {
              app.stage.removeChild(currentTargetSprite);
            }

            // æ˜¾ç¤ºå‡»æ¯æ•ˆæœ
            const boom = new PIXI.Text('ğŸ’¥ å‡»æ¯!', {
              fontFamily: 'Arial',
              fontSize: 36,
              fill: 0xFF4500
            });
            // å®šä½åˆ°è¢«å‡»æ¯ç›®æ ‡çš„ä½ç½®
            if (currentTargetSprite) {
                 boom.x = currentTargetSprite.x;
                 boom.y = currentTargetSprite.y;
            } else { // å¦‚æœ sprite æ„å¤–ä¸¢å¤±ï¼Œæ”¾åœ¨å±å¹•ä¸­é—´
                 boom.x = app.screen.width / 2 - boom.width / 2;
                 boom.y = app.screen.height / 2 - boom.height / 2;
            }
            app.stage.addChild(boom);
            
            // æ¸…ç†å…¨å±€çŠ¶æ€
            currentTarget = null;
            currentTargetSprite = null;
            currentTargetTickerCallback = null;

            // å‡†å¤‡ä¸‹ä¸€ä¸ªç›®æ ‡ï¼Œå¹¶ç§»é™¤å‡»æ¯æ•ˆæœ
            setTimeout(() => {
              if (app.stage.children.includes(boom)) {
                 app.stage.removeChild(boom);
              }
              createFlyingTarget();
            }, 800); // å»¶è¿Ÿååˆ›å»ºæ–°ç›®æ ‡

          } else {
            // æœªå‡»æ¯ï¼Œä»…æ˜¾ç¤ºå‘½ä¸­æ•ˆæœ
            const hitText = new PIXI.Text('âœ“ æ­£ç¡®!', {
              fontFamily: 'Arial',
              fontSize: 24,
              fill: 0x00FF00
            });
            hitText.x = app.screen.width / 2 - 50;
            hitText.y = 50;
            app.stage.addChild(hitText);
            
            setTimeout(() => {
              if (app.stage.children.includes(hitText)) {
                  app.stage.removeChild(hitText);
              }
            }, 500);
          }
        } else {
          // é”™è¯¯åé¦ˆ
          console.log(`å£°è°ƒé”™è¯¯! ç›®æ ‡ '${currentTarget.char}' éœ€è¦ tone ${currentTarget.tone}, é€‰æ‹©äº† tone ${selectedTone}`); // æ—¥å¿—
          const missText = new PIXI.Text('âœ— å£°è°ƒé”™è¯¯!', { // æ›´æ–°æç¤ºä¿¡æ¯
            fontFamily: 'Arial',
            fontSize: 24,
            fill: 0xFF0000
          });
          missText.x = app.screen.width / 2 - 50;
          missText.y = 50;
          app.stage.addChild(missText);
          
          setTimeout(() => {
            app.stage.removeChild(missText);
          }, 500);
        }
      }

      // åˆå§‹åŒ–æ¸¸æˆ
      createCharacterButtons();
      createFlyingTarget();

      // ç»‘å®šéŸ³è°ƒæŒ‰é’® - è°ƒç”¨æ–°çš„ checkAnswer
      document.querySelectorAll('.tone-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tone = parseInt(btn.dataset.tone);
          // alert(`ä½ é€‰æ‹©äº† ${btn.textContent}ï¼Œåç»­å¯ä»¥æ‰©å±•éŸ³è°ƒéªŒè¯åŠŸèƒ½`); // ç§»é™¤ alert
          if (currentTarget) { // ç¡®ä¿æœ‰ç›®æ ‡æ—¶æ‰æ£€æŸ¥
             checkAnswer(tone); // è°ƒç”¨æ–°çš„ checkAnswerï¼Œä¼ å…¥å£°è°ƒ
          } else {
             console.log("ç‚¹å‡»å£°è°ƒæŒ‰é’®ï¼Œä½†å½“å‰æ— ç›®æ ‡");
          }
        });
      });
    });
  </script>
</body>
</html>
